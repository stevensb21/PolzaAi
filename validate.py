from api_settings import DATE_CONVERSION_PRIORITY, ORDER_FORMAT_PRIORITY
from ai_request import make_api_request_with_fallback


async def convert_date(date):
    try:
        response, used_client, used_model = await make_api_request_with_fallback(
            priority_list=DATE_CONVERSION_PRIORITY,
            messages=[
                {"role": "system", "content": """

                    –¢—ã –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–∞—Ç, —Ç—ã —É–º–µ–µ—à—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É –∏–∑ –ª—é–±–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –≤ sql —Ñ–æ—Ä–º–∞—Ç yyyy-mm-dd
                    –í–æ–∑–≤—Ä–∞—â–∞–µ—à—å —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –≤ sql —Ñ–æ—Ä–º–∞—Ç–µ yyyy-mm-dd –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫

                """},
                {"role": "user", "content": date},   
            ],

            temperature=0.1,
            task_name="–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞—Ç—ã"
        )
        
        if not response:
            print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞—Ç—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é: {date}")
            return date
            
        # –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        result = response.choices[0].message.content.strip().strip('"').strip("'")
        print(f"üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {used_client} / {used_model}")
        print(f"‚úÖ –î–∞—Ç–∞ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞: {date} ‚Üí {result}")
        return result
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–∞—Ç—ã: {e}")
        return date



async def makeOrderformat(order, chat_history=None):
    messages_with_system = [
        {"role": "system", "content": """–¢—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—à—å –∑–∞–∫–∞–∑ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞.

–í–ê–ñ–ù–û: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–Æ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ + —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!
–î–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–±—Ä–æ—Å–∞–Ω—ã –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º.

–ò–ó –í–°–ï–• –°–û–û–ë–©–ï–ù–ò–ô –∏–∑–≤–ª–µ–∫–∞–π:
- full_name - –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç)
- position - –¥–æ–ª–∂–Ω–æ—Å—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–ª—é–±–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è)
- phone - —Ç–µ–ª–µ—Ñ–æ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç)
- snils - –°–ù–ò–õ–° —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (XXX-XXX-XXX XX –∏–ª–∏ XXXXXXXXXX)
- inn - –ò–ù–ù —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- birth_date - –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π –≤ yyyy-mm-dd)

–ü–†–ê–í–ò–õ–ê:
1. –û–±—ä–µ–¥–∏–Ω—è–π –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏
2. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö - –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö
3. –ï—Å–ª–∏ –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–¥.–º–º.–≥–≥–≥–≥ - –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–π –≤ yyyy-mm-dd
4. –ï—Å–ª–∏ –∫–∞–∫–∏—Ö-—Ç–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É ""

–í–æ–∑–≤—Ä–∞—â–∞–π JSON –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
{
    "full_name": "string",
    "position": "string", 
    "phone": "string",
    "snils": "string",
    "inn": "string",
    "birth_date": "string"
}"""},
        {"role": "user", "content": f"–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {order}"}
    ]
    
    if chat_history:
        messages_with_system.append({"role": "user", "content": f"–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞: {chat_history}"})

    response, used_client, used_model = await make_api_request_with_fallback(
            priority_list=ORDER_FORMAT_PRIORITY,
            messages=messages_with_system,
            temperature=0.1,
            task_name="–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞"
        )
    if not response:
        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –∑–∞–∫–∞–∑–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–∫–∞–∑: {order}")
        return order
    result = response.choices[0].message.content.strip().strip('"').strip("'")
    print(f"üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {used_client} / {used_model}")
    print(f"‚úÖ –§–æ—Ä–º–∞—Ç –∑–∞–∫–∞–∑–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: {order} ‚Üí {result}")
    return result

async def validateOrder(order, chat_history):
    messages_with_system = [
        {"role": "system", "content": """–¢—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–∞–∫–∞–∑–∞. –í–ê–ñ–ù–û: –≠—Ç–æ –¥–∏–∞–ª–æ–≥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –≤–≤–æ–¥–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —á–∞—Å—Ç—è–º–∏!

–ü–†–ê–í–ò–õ–ê –ê–ù–ê–õ–ò–ó–ê:
1. –°–æ–±–µ—Ä–∏ –í–°–ï –¥–∞–Ω–Ω—ã–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ + —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
2. –≠—Ç–æ –û–î–ò–ù –∑–∞–∫–∞–∑, –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
3. –ï—Å–ª–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å –§–ò–û, –∞ –≤ —Ç–µ–∫—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –¥–æ–ª–∂–Ω–æ—Å—Ç—å - —ç—Ç–æ –û–î–ò–ù —á–µ–ª–æ–≤–µ–∫!

–ü–†–ò–ú–ï–†:
- –ò—Å—Ç–æ—Ä–∏—è: "–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á, –°–ù–ò–õ–°: 123-456-789 01, 01.01.1990"
- –¢–µ–∫—É—â–µ–µ: "–ú–µ–Ω–µ–¥–∂–µ—Ä, +7-999-123-45-67"
- –†–ï–ó–£–õ–¨–¢–ê–¢: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã! (–§–ò–û –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ + –¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ)

–ü–†–ò–ú–ï–† 2:
- –ò—Å—Ç–æ—Ä–∏—è: "–ï–≥–æ—Ä–æ–≤ –ê–Ω–¥—Ä–µ–π –§–µ–¥–æ—Ä–æ–≤–∏—á, –°–ù–ò–õ–°: 199-010-000-00, +79631218121, –ü—Ä–æ—Ä–∞–±"
- –¢–µ–∫—É—â–µ–µ: "16.09.1994"
- –†–ï–ó–£–õ–¨–¢–ê–¢: –í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã! (–§–ò–û, –°–ù–ò–õ–°, —Ç–µ–ª–µ—Ñ–æ–Ω, –¥–æ–ª–∂–Ω–æ—Å—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ + –¥–∞—Ç–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ)

–ò–©–ò –í –í–°–ï–• –°–û–û–ë–©–ï–ù–ò–Ø–•:
- –§–ò–û (–ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –î–æ–ª–∂–Ω–æ—Å—Ç—å (–ª—é–±–∞—è –ø—Ä–æ—Ñ–µ—Å—Å–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –¢–µ–ª–µ—Ñ–æ–Ω (–ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç: +7, 8, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –°–ù–ò–õ–° (XXX-XXX-XXX XX –∏–ª–∏ XXXXXXXXXX –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–ª—é–±–æ–π —Ñ–æ—Ä–º–∞—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: 16.09.1994, 16/09/1994, 16-09-1994, 16.09.94 –∏ —Ç.–¥.)
- –ò–ù–ù (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

–ï—Å–ª–∏ –í–°–ï –Ω–∞–π–¥–µ–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–π: {"success": true, "message": "–í—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–π–¥–µ–Ω—ã"}
–ï—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–π: {"error": "missing_data", "message": "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç: [—á—Ç–æ –∏–º–µ–Ω–Ω–æ]"}"""},
        {"role": "user", "content": f"–¢–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: {order}"},
        {"role": "user", "content": f"–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞: {chat_history}"}
    ]

    response, used_client, used_model = await make_api_request_with_fallback(
            priority_list=ORDER_FORMAT_PRIORITY,
            messages=messages_with_system,
            task_name="–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–∫–∞–∑–∞"
        )
    if not response:
        print(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–∫–∞–∑–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–∫–∞–∑: {order}")
        return order
    result = response.choices[0].message.content.strip().strip('"').strip("'")
    print(f"üìä –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω: {used_client} / {used_model}")
    print(f"‚úÖ –î–∞–Ω–Ω—ã–µ –≤ –∑–∞–∫–∞–∑–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã: {order} ‚Üí {result}")
    return result

